name: unified-nasm-dotnet-jvm-llvm-v2

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ############################################################
      # OS Dependencies
      ############################################################

      - name: Install deps (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y nasm clang openjdk-17-jdk dotnet-sdk-8.0 zip python3

      - name: Install deps (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install nasm llvm openjdk dotnet zip python

      - name: Install deps (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install nasm llvm openjdk dotnet-8.0 python
        shell: pwsh

      ############################################################
      # Meaning Based Transpiler (파일은 src/에 있음)
      ############################################################

      - name: Run Meaning-Based Transpiler
        run: |
          python3 src/meaning_transpiler.py src/ out/
        shell: bash

      ############################################################
      # Build Backends
      ############################################################

      # 1) NASM Native
      - name: Build NASM Native
        run: |
          if [ -f out/native/main.asm ]; then
            nasm -f elf64 out/native/main.asm -o out/native/main.o || true
            clang out/native/main.o -o out/native_app || true
          fi
        shell: bash

      # 2) LLVM (clang → binary)
      - name: Build LLVM Backend
        run: |
          if [ -f out/llvm/main.c ]; then
            clang out/llvm/main.c -o out/llvm_app || true
          fi
        shell: bash

      # 3) JVM Backend
      - name: Build JVM Backend
        run: |
          if [ -f out/jvm/Main.java ]; then
            javac out/jvm/Main.java || true
            jar cfe out/jvm_app.jar Main -C out/jvm . || true
          fi
        shell: bash

      # 4) .NET Backend
      - name: Build .NET Backend
        run: |
          if [ -f out/dotnet/Program.cs ]; then
            dotnet new console -o dotnet_build -n TempProj --force
            cp out/dotnet/Program.cs dotnet_build/Program.cs
            dotnet build dotnet_build -c Release
            cp dotnet_build/bin/Release/net8.0/TempProj.dll out/dotnet/
          fi
        shell: bash

      ############################################################
      # Packaging
      ############################################################

      - name: Package (ZIP)
        run: |
          cd out
          zip -r build_${{ matrix.os }}.zip ./
        shell: bash

      ############################################################
      # SHA256 Proof + Ledger
      ############################################################

      - name: SHA256 Proof
        run: |
          mkdir -p proof
          sha256sum out/build_${{ matrix.os }}.zip > proof/sha256_${{ matrix.os }}.txt
        shell: bash

      - name: Build Ledger
        run: |
          mkdir -p proof
          echo "Timestamp: $(date +%Y%m%d-%H%M%S)" > proof/ledger_${{ matrix.os }}.txt
          echo "Commit: $GITHUB_SHA" >> proof/ledger_${{ matrix.os }}.txt
          echo "OS: ${{ matrix.os }}" >> proof/ledger_${{ matrix.os }}.txt
          echo "Transpiler: meaning_transpiler.py in src/" >> proof/ledger_${{ matrix.os }}.txt
        shell: bash

      ############################################################
      # Artifact Upload
      ############################################################

      - name: Upload Build ZIP
        uses: actions/upload-artifact@v4
        with:
          name: build_${{ matrix.os }}
          path: out/build_${{ matrix.os }}.zip

      - name: Upload Proof Files
        uses: actions/upload-artifact@v4
        with:
          name: proof_${{ matrix.os }}
          path: proof/

