name: meaning-v3-3OS-full

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    # ---------------------------------------------------------
    # Checkout
    # ---------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # Install Dependencies
    # ---------------------------------------------------------
    - name: Install deps (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc clang nasm zip

    - name: Install deps (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install nasm || true

    - name: Install deps (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        choco install mingw -y
        choco install nasm -y
        refreshenv
        gcc --version

    # ---------------------------------------------------------
    # Meaning IR 생성
    # ---------------------------------------------------------
    - name: Run Meaning Transpiler
      shell: bash
      run: |
        python3 src/meaning_engine.py transpile src/ out/
        echo "=== IR created ==="
        cat out/ir.json

    # ---------------------------------------------------------
    # Meaning VM 실행 테스트
    # ---------------------------------------------------------
    - name: Run Meaning VM (semantic execution)
      shell: bash
      run: |
        python3 src/meaning_engine.py runvm out/ir.json

    # ---------------------------------------------------------
    # Build Native Executable for each OS
    # ---------------------------------------------------------
    - name: Build LLVM Executable (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        cd out/llvm
        gcc main.c -o meaning_app
        echo "=== Built Linux/macOS executable ==="
        ls -l meaning_app

    - name: Build LLVM Executable (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        cd out/llvm
        gcc main.c -o meaning_app.exe
        Write-Host "=== Built Windows executable ==="
        dir meaning_app.exe

    # ---------------------------------------------------------
    # Run Executable (3OS Full Execution Test)
    # ---------------------------------------------------------
    - name: Run Executable (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        cd out/llvm
        chmod +x meaning_app
        echo "=== Running executable ==="
        ./meaning_app

    - name: Run Executable (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        cd out/llvm
        Write-Host "=== Running executable ==="
        ./meaning_app.exe

    # ---------------------------------------------------------
    # Create ZIP
    # ---------------------------------------------------------
    - name: Create ZIP (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        cd out
        zip -r build_${{ matrix.os }}.zip \
            llvm/meaning_app \
            ir.json \
            jvm \
            dotnet \
            native
        ls -l build_${{ matrix.os }}.zip

    - name: Create ZIP (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        cd out
        Compress-Archive -Path llvm\meaning_app.exe, ir.json, jvm, dotnet, native `
          -DestinationPath build_windows-latest.zip
        dir build_windows-latest.zip

    # ---------------------------------------------------------
    # Upload artifacts
    # ---------------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: out/*.zip

  # ---------------------------------------------------------
  # Release Job
  # ---------------------------------------------------------
  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v3.${{ github.run_number }}
        name: Meaning Engine v3 Release (${{ github.run_number }})
        body: |
          Meaning Engine v3 – Automatic 3OS Build + Execution Verified
        files: |
          build-ubuntu-latest/*.zip
          build-macos-latest/*.zip
          build-windows-latest/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

